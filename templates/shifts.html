{% extends "dashboard_base.html" %}

{% block title %}Shift Management{% endblock %}

{% block content %}
<div class="content-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>Shift Management</h1>
            <p class="text-muted mb-0">Manage staff schedules, check-ins, and handoffs</p>
        </div>
        {% if staff.role == 'admin' %}
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createShiftModal">
            <i data-feather="plus"></i> Create Shift
        </button>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Today's Shifts</h5>
            </div>
            <div class="card-body">
                {% if todays_shifts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Role</th>
                                <th>Shift</th>
                                <th>Time</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift in todays_shifts %}
                            <tr>
                                <td>
                                    <strong>{{ shift.staff.full_name }}</strong><br>
                                    <small class="text-muted">{{ shift.staff.staff_id }}</small>
                                </td>
                                <td>
                                    <span class="badge badge-{{ 'primary' if shift.staff.role == 'doctor' else 'info' }}">
                                        {{ shift.staff.role|upper }}
                                    </span>
                                </td>
                                <td>{{ shift.shift_type|title }}</td>
                                <td>
                                    {{ shift.start_time.strftime('%H:%M') }} - {{ shift.end_time.strftime('%H:%M') }}
                                </td>
                                <td>{{ shift.department or 'General' }}</td>
                                <td>
                                    {% if shift.checked_out_at %}
                                    <span class="badge badge-secondary">Completed</span>
                                    {% elif shift.checked_in_at %}
                                    <span class="badge badge-success">On Duty</span>
                                    {% else %}
                                    <span class="badge badge-warning">Scheduled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not shift.checked_in_at %}
                                    <form method="POST" action="{{ url_for('shift_check_in', shift_id=shift.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success" {% if shift.staff_id != staff.id and staff.role != 'admin' %}disabled{% endif %}>
                                            <i data-feather="log-in"></i> Check In
                                        </button>
                                    </form>
                                    {% elif not shift.checked_out_at %}
                                    <form method="POST" action="{{ url_for('shift_check_out', shift_id=shift.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-warning" {% if shift.staff_id != staff.id and staff.role != 'admin' %}disabled{% endif %}>
                                            <i data-feather="log-out"></i> Check Out
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i data-feather="calendar" style="width: 48px; height: 48px;" class="text-muted"></i>
                    <p class="mt-3 text-muted">No shifts scheduled for today</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Pending Handoffs</h5>
                <a href="{{ url_for('create_handoff') }}" class="btn btn-sm btn-outline-primary">
                    <i data-feather="file-plus"></i> Create Handoff
                </a>
            </div>
            <div class="card-body">
                {% if pending_handoffs %}
                <div class="handoff-list">
                    {% for handoff in pending_handoffs %}
                    <div class="handoff-card {% if handoff.incoming_staff_id == staff.id %}highlight{% endif %}">
                        <div class="handoff-header">
                            <div>
                                <strong>{{ handoff.outgoing_staff.full_name }}</strong>
                                <i data-feather="arrow-right" class="mx-2"></i>
                                <strong>{{ handoff.incoming_staff.full_name }}</strong>
                            </div>
                            <small class="text-muted">{{ handoff.handoff_time.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        
                        {% if handoff.patient %}
                        <div class="handoff-patient">
                            <span class="badge badge-light">Patient: {{ handoff.patient.full_name }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="handoff-summary">
                            <p class="mb-2">{{ handoff.summary }}</p>
                            {% if handoff.critical_notes %}
                            <div class="critical-notes">
                                <strong class="text-danger">Critical:</strong> {{ handoff.critical_notes }}
                            </div>
                            {% endif %}
                            {% if handoff.pending_tasks %}
                            <div class="pending-tasks mt-2">
                                <strong>Pending Tasks:</strong> {{ handoff.pending_tasks }}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if handoff.incoming_staff_id == staff.id %}
                        <div class="handoff-actions mt-3">
                            <form method="POST" action="{{ url_for('acknowledge_handoff', handoff_id=handoff.id) }}">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i data-feather="check"></i> Acknowledge Handoff
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center mb-0 py-3">No pending handoffs</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Currently On Duty</h5>
            </div>
            <div class="card-body">
                {% if on_duty_staff %}
                <div class="on-duty-list">
                    {% for member in on_duty_staff %}
                    <div class="on-duty-item">
                        <div class="staff-info">
                            <div class="staff-avatar {{ member.role }}">
                                {{ member.first_name[0] }}{{ member.last_name[0] }}
                            </div>
                            <div>
                                <strong>{{ member.full_name }}</strong><br>
                                <small class="text-muted">{{ member.role|title }} - {{ member.department or 'General' }}</small>
                            </div>
                        </div>
                        <span class="badge badge-success">On Duty</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0 text-center py-3">No staff currently on duty</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Staff Summary</h5>
            </div>
            <div class="card-body">
                <div class="stat-row">
                    <span class="stat-label">Total Doctors</span>
                    <span class="stat-value">{{ all_staff|selectattr('role', 'equalto', 'doctor')|list|length }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Nurses</span>
                    <span class="stat-value">{{ all_staff|selectattr('role', 'equalto', 'nurse')|list|length }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">On Duty Now</span>
                    <span class="stat-value text-success">{{ on_duty_staff|length }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% if staff.role == 'admin' %}
<div class="modal fade" id="createShiftModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Shift</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('create_shift') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Staff Member</label>
                        <select name="staff_id" class="form-control" required>
                            <option value="">Select Staff</option>
                            {% for member in all_staff %}
                            <option value="{{ member.id }}">{{ member.full_name }} ({{ member.role|title }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" name="date" class="form-control" required value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="form-group">
                        <label>Shift Type</label>
                        <select name="shift_type" class="form-control" required>
                            <option value="morning">Morning (7:00 - 15:00)</option>
                            <option value="afternoon">Afternoon (15:00 - 23:00)</option>
                            <option value="night">Night (23:00 - 7:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <select name="department" class="form-control">
                            <option value="General">General</option>
                            <option value="ICU">ICU</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Cardiology">Cardiology</option>
                            <option value="Pediatrics">Pediatrics</option>
                            <option value="Surgery">Surgery</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Shift</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.handoff-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.handoff-card {
    padding: 16px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.handoff-card.highlight {
    border-color: #007bff;
    background: rgba(0, 123, 255, 0.05);
}

.handoff-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.handoff-patient {
    margin-bottom: 8px;
}

.handoff-summary {
    font-size: 0.9rem;
}

.critical-notes {
    padding: 8px;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 4px;
    font-size: 0.85rem;
}

.pending-tasks {
    font-size: 0.85rem;
    color: #666;
}

.on-duty-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.on-duty-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.staff-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.staff-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.85rem;
    color: white;
}

.staff-avatar.doctor { background: #007bff; }
.staff-avatar.nurse { background: #17a2b8; }

.stat-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-label {
    color: #6c757d;
}

.stat-value {
    font-weight: 600;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>
{% endblock %}
