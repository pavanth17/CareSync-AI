{% extends "dashboard_base.html" %}

{% block title %}Medications - {{ patient.full_name }}{% endblock %}

{% block content %}
<div class="content-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>Medication Management</h1>
            <p class="text-muted mb-0">Patient: {{ patient.full_name }} | Room {{ patient.room_number }}, Bed {{ patient.bed_number }}</p>
        </div>
        <div>
            {% if staff.role in ['doctor', 'admin'] %}
            <a href="{{ url_for('medication_schedule', patient_id=patient.id) }}" class="btn btn-primary">
                <i data-feather="plus"></i> Schedule New Medication
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Active Medications</h5>
            </div>
            <div class="card-body">
                {% if medications %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Medication</th>
                                <th>Dosage</th>
                                <th>Frequency</th>
                                <th>Route</th>
                                <th>Next Due</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for med in medications %}
                            <tr class="{{ 'table-warning' if med.next_due and med.next_due <= now else '' }}">
                                <td>
                                    <strong>{{ med.name }}</strong>
                                    {% if med.notes %}
                                    <br><small class="text-muted">{{ med.notes[:50] }}...</small>
                                    {% endif %}
                                </td>
                                <td>{{ med.dosage }}</td>
                                <td>{{ med.frequency }}</td>
                                <td>{{ med.route or '-' }}</td>
                                <td>
                                    {% if med.next_due %}
                                        {% if med.next_due <= now %}
                                        <span class="badge badge-danger">OVERDUE</span><br>
                                        {% endif %}
                                        {{ med.next_due.strftime('%H:%M') }}
                                    {% else %}
                                        PRN
                                    {% endif %}
                                </td>
                                <td>
                                    {% if staff.role in ['nurse', 'admin'] %}
                                    <form method="POST" action="{{ url_for('administer_medication', medication_id=med.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success" title="Record Administration">
                                            <i data-feather="check"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i data-feather="inbox" style="width: 48px; height: 48px;" class="text-muted"></i>
                    <p class="mt-3 text-muted">No active medications</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Administration History (Audit Trail)</h5>
            </div>
            <div class="card-body">
                {% if administrations %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Medication</th>
                                <th>Dosage</th>
                                <th>Administered By</th>
                                <th>Status</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for admin in administrations %}
                            <tr>
                                <td>{{ admin.administered_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ admin.medication.name }}</td>
                                <td>{{ admin.dosage_given }}</td>
                                <td>{{ admin.administered_by.full_name }}</td>
                                <td>
                                    <span class="badge badge-{{ 'success' if admin.status == 'administered' else 'warning' if admin.status == 'held' else 'secondary' }}">
                                        {{ admin.status|upper }}
                                    </span>
                                </td>
                                <td>{{ admin.notes[:30] if admin.notes else '-' }}{% if admin.notes and admin.notes|length > 30 %}...{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0 text-center py-3">No administration records yet</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Patient Summary</h5>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Patient ID</dt>
                    <dd>{{ patient.patient_id }}</dd>
                    
                    <dt>Age / Gender</dt>
                    <dd>{{ patient.age }} years / {{ patient.gender }}</dd>
                    
                    <dt>Blood Type</dt>
                    <dd>{{ patient.blood_type or 'Unknown' }}</dd>
                    
                    <dt>Allergies</dt>
                    <dd>{{ patient.notes or 'None recorded' }}</dd>
                    
                    <dt>Diagnosis</dt>
                    <dd>{{ patient.diagnosis or 'Pending' }}</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('patient_detail', patient_id=patient.id) }}" class="btn btn-outline-primary btn-block mb-2">
                    <i data-feather="user"></i> View Patient Details
                </a>
                <a href="{{ url_for('patient_history', patient_id=patient.id) }}" class="btn btn-outline-secondary btn-block mb-2">
                    <i data-feather="clock"></i> View Full History
                </a>
                <a href="{{ url_for('patient_risk_analysis', patient_id=patient.id) }}" class="btn btn-outline-info btn-block">
                    <i data-feather="activity"></i> Run Risk Analysis
                </a>
            </div>
        </div>

        {% if past_medications %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Discontinued Medications</h5>
            </div>
            <div class="card-body">
                <ul class="discontinued-list">
                    {% for med in past_medications %}
                    <li>
                        <strong>{{ med.name }}</strong> {{ med.dosage }}<br>
                        <small class="text-muted">Ended: {{ med.end_date.strftime('%Y-%m-%d') if med.end_date else 'Unknown' }}</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
dl dt {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.85rem;
    margin-top: 12px;
}

dl dd {
    margin-bottom: 0;
    color: #1a1a2e;
}

dl dt:first-child {
    margin-top: 0;
}

.discontinued-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.discontinued-list li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.discontinued-list li:last-child {
    border-bottom: none;
}

.btn-block {
    display: block;
    width: 100%;
}
</style>
{% endblock %}
