{% extends "dashboard_base.html" %}

{% block title %}Ward Management - CareSync AI{% endblock %}

{% block dashboard_content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h1><i class="bi bi-hospital me-2"></i>Ward Management</h1>
        <p class="text-muted">Manage hospital wards, capacity, and head nurses</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createWardModal">
            <i class="bi bi-plus-lg me-1"></i>Add New Ward
        </button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Ward Name</th>
                                <th>Location</th>
                                <th>Capacity</th>
                                <th>Occupancy</th>
                                <th>Head Nurse</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in ward_stats %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ stat.ward.name }}</td>
                                <td>{{ stat.ward.floor or '-' }}</td>
                                <td>{{ stat.ward.capacity }} Beds</td>
                                <td style="width: 200px;">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar bg-{{ 'success' if stat.percent < 70 else 'warning' if stat.percent < 90 else 'danger' }}"
                                                style="width: {{ stat.percent }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ stat.occupancy }}/{{ stat.ward.capacity }}</small>
                                    </div>
                                </td>
                                <td>
                                    {% if stat.ward.head_nurse %}
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle sm bg-info text-white me-2">
                                            {{ stat.ward.head_nurse.first_name[0] }}
                                        </div>
                                        <div>
                                            <div class="small fw-bold">{{ stat.ward.head_nurse.full_name }}</div>
                                            <div class="small text-muted" style="font-size: 0.75rem;">ID: {{
                                                stat.ward.head_nurse.staff_id }}</div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted small">Not Assigned</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-secondary"
                                        onclick="editWard('{{ stat.ward.id }}', '{{ stat.ward.name }}', '{{ stat.ward.capacity }}', '{{ stat.ward.floor }}', '{{ stat.ward.head_nurse_id }}')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createWardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Ward</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin_wards') }}" method="POST">
                <input type="hidden" name="action" value="create">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ward Name</label>
                        <input type="text" name="name" class="form-control" required placeholder="e.g. Cardiology">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Capacity (Beds)</label>
                            <input type="number" name="capacity" class="form-control" required value="20">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Floor/Location</label>
                            <input type="text" name="floor" class="form-control" placeholder="e.g. 3rd Floor">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Ward</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editWardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Ward</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin_wards') }}" method="POST">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="ward_id" id="edit_ward_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ward Name</label>
                        <input type="text" name="name" id="edit_name" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Capacity (Beds)</label>
                            <input type="number" name="capacity" id="edit_capacity" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Floor/Location</label>
                            <input type="text" name="floor" id="edit_floor" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Head Nurse</label>
                        <select name="head_nurse_id" id="edit_head_nurse" class="form-select">
                            <option value="">-- Select Head Nurse --</option>
                            {% for nurse in nurses %}
                            <option value="{{ nurse.id }}">{{ nurse.full_name }} ({{ nurse.staff_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function editWard(id, name, capacity, floor, head_nurse_id) {
        document.getElementById('edit_ward_id').value = id;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_capacity').value = capacity;
        document.getElementById('edit_floor').value = floor !== 'None' ? floor : '';
        document.getElementById('edit_head_nurse').value = head_nurse_id !== 'None' ? head_nurse_id : '';

        new bootstrap.Modal(document.getElementById('editWardModal')).show();
    }
</script>
{% endblock %}